--- SUPPRESSION DU SCHEMA ---
DROP SCHEMA IF EXISTS labo CASCADE;

--- CREATION DU SCHEMA ---
CREATE SCHEMA labo;
SET search_path TO labo;


--- CREATION DES TABLES ---

CREATE TABLE EMPLOYEUR(
    id_employeur SERIAL,
    nom_employeur VARCHAR(255) NOT NULL,
    PRIMARY KEY(id_employeur)
);

CREATE TABLE EQUIPE(
    id_equipe SERIAL,
    nom_equipe VARCHAR(255) NOT NULL,
    PRIMARY KEY(id_equipe),
    UNIQUE(nom_equipe)
);

CREATE TABLE TYPE_SUPPORT(
    id_tsupp SERIAL,
    nom_nature_tsupp VARCHAR(255) NOT NULL,
    PRIMARY KEY(id_tsupp),
    UNIQUE(nom_nature_tsupp)
);

CREATE TABLE CATEGORIE(
    id_categorie SERIAL,
    nom_categorie VARCHAR(255) NOT NULL,
    PRIMARY KEY(id_categorie),
    UNIQUE(nom_categorie)
);

CREATE TABLE CIVILITE(
    id_civilite SERIAL,
    nom_civilite VARCHAR(255) NOT NULL,
    PRIMARY KEY(id_civilite)
);

CREATE TABLE GRADE(
   id_grade SERIAL,
   nom_grade VARCHAR(255) NOT NULL,
   PRIMARY KEY(id_grade),
   UNIQUE(nom_grade)
);

CREATE TABLE PAYS(
    id_pays SERIAL,
    nom_pays VARCHAR(255) NOT NULL,
    PRIMARY KEY(id_pays),
    UNIQUE(nom_pays)
);

CREATE TABLE CNU(
    id_cnu SERIAL,
    num_cnu VARCHAR(5) NOT NULL,
    PRIMARY KEY(id_cnu),
    UNIQUE(num_cnu)
);

CREATE TABLE SECTION(
    id_sec SERIAL,
    section_conrs VARCHAR(5) NOT NULL,
    PRIMARY KEY(id_sec)
);

CREATE TABLE PERSONNE(
    id_p SERIAL,
    nom_p VARCHAR(255) NOT NULL,
    prenom_p VARCHAR(255) NOT NULL,
    date_arrive DATE NOT NULL,
    date_n DATE NOT NULL,
    id_sec INT NOT NULL,
    id_cnu INT NOT NULL,
    id_categorie INT NOT NULL,
    id_grade INT NOT NULL,
    id_employeur INT,
    nom_directeur VARCHAR(255),
    id_civilite INT NOT NULL,
    id_pays INT,
    UNIQUE(nom_p, prenom_p),
    PRIMARY KEY(id_p),
    FOREIGN KEY(id_sec) REFERENCES SECTION(id_sec),
    FOREIGN KEY(id_cnu) REFERENCES CNU(id_cnu),
    FOREIGN KEY(id_categorie) REFERENCES CATEGORIE(id_categorie),
    FOREIGN KEY(id_grade) REFERENCES GRADE(id_grade),
    FOREIGN KEY(id_employeur) REFERENCES EMPLOYEUR(id_employeur),
    FOREIGN KEY(id_civilite) REFERENCES CIVILITE(id_civilite),
    FOREIGN KEY(id_pays) REFERENCES PAYS(id_pays)
);

CREATE TABLE AFFECTATION(
    id_equipe INT,
    id_p INT,
    debut_affectation DATE NOT NULL,
    fin_affectation DATE DEFAULT '01/01/0001',
    PRIMARY KEY(id_equipe, id_p),
    FOREIGN KEY(id_equipe) REFERENCES EQUIPE(id_equipe),
    FOREIGN KEY(id_p) REFERENCES PERSONNE(id_p),
    CHECK((fin_affectation > debut_affectation) OR (fin_affectation = '01/01/0001'))
);

CREATE TABLE SUPPORT(
    id_tsupp INT,
    id_p INT,
    quotite VARCHAR(255),
    debut_supp DATE NOT NULL,
    fin_supp DATE DEFAULT '01/01/0001',
    PRIMARY KEY(id_tsupp, id_p),
    FOREIGN KEY(id_tsupp) REFERENCES TYPE_SUPPORT(id_tsupp),
    FOREIGN KEY(id_p) REFERENCES PERSONNE(id_p),
    CHECK((fin_supp > debut_supp) OR (fin_supp = '01/01/0001'))
);
